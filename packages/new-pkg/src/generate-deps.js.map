{"version":3,"sources":["../src/generate-deps.js"],"names":["generateDeps","filePathList","hostpkgJsonPath","ignore","hostPkgJson","_","defaults","JSON","parse","fs","readFile","encoding","dependencies","devDependencies","dependenciesRawList","dependenciesRawListFilePath","Bluebird","map","filePathItem","inputCode","ast","sourceType","plugins","visitor","ImportDeclaration","babelPath","moduleId","node","source","value","segments","split","path","sep","name","scopedName","some","item","startsWith","repl","_builtinLibs","includes","push","CallExpression","callee","arguments","hostDependencies","realdependencies","index","hostPkgJsonDepVersion","hostPkgJsonDevDepVersion","hostPkgJsonVersion","require","realPkgJsonPath","resolvePkg","resolve","error","messageMatch","message","match","newMessage","slice","length","join","realPkgJson","realPkgJsonVersion","version","hostDependenciesSorted","Object","keys","sort","reduce","acc","key","realDependenciesSorted","modulePath","lastIndexOf","TypeError"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;;;AAEe,eAAeA,YAAf,CAA4BC,YAA5B,EAA0CC,eAA1C,EAA2D;AAAEC,EAAAA,MAAM,GAAG;AAAX,IAAkB,EAA7E,EAAiF;AAC9F,QAAMC,WAAW,GAAGC,gBAAEC,QAAF,CAClBC,IAAI,CAACC,KAAL,CAAW,MAAMC,kBAAGC,QAAH,CAAYR,eAAZ,EAA6B;AAAES,IAAAA,QAAQ,EAAE;AAAZ,GAA7B,CAAjB,CADkB,EAElB;AACEC,IAAAA,YAAY,EAAE,EADhB;AAEEC,IAAAA,eAAe,EAAE;AAFnB,GAFkB,CAApB;;AAQA,QAAMC,mBAAmB,GAAG,EAA5B;AACA,QAAMC,2BAA2B,GAAG,EAApC;AAEA,QAAMC,kBAASC,GAAT,CAAahB,YAAb,EAA2B,MAAOiB,YAAP,IAAwB;AACvD,UAAMC,SAAS,GAAG,MAAMV,kBAAGC,QAAH,CAAYQ,YAAZ,EAA0B;AAAEP,MAAAA,QAAQ,EAAE;AAAZ,KAA1B,CAAxB;AACA,UAAMS,GAAG,GAAG,mBAAWD,SAAX,EAAsB;AAChCE,MAAAA,UAAU,EAAE,QADoB;AAEhCC,MAAAA,OAAO,EAAE,CAAC,KAAD,EAAQ,YAAR;AAFuB,KAAtB,CAAZ;AAKA,UAAMC,OAAO,GAAG;AACdC,MAAAA,iBAAiB,CAACC,SAAD,EAAY;AAC3B,YAAIC,QAAQ,GAAGD,SAAS,CAACE,IAAV,CAAeC,MAAf,CAAsBC,KAArC;AACA,cAAMC,QAAQ,GAAGJ,QAAQ,CAACK,KAAT,CAAeC,cAAKC,GAApB,CAAjB;AACA,cAAMC,IAAI,GAAGJ,QAAQ,CAAC,CAAD,CAArB;;AAEA,YAAII,IAAI,CAAC,CAAD,CAAJ,KAAY,GAAhB,EAAqB;AACnB,gBAAMC,UAAU,GAAGL,QAAQ,CAAC,CAAD,CAA3B;AACAJ,UAAAA,QAAQ,GAAI,GAAEQ,IAAK,IAAGC,UAAW,EAAjC;AACD,SAHD,MAGO;AACLT,UAAAA,QAAQ,GAAGQ,IAAX;AACD;;AAED,YACE,CAAC/B,MAAM,CAACiC,IAAP,CAAaC,IAAD,IAAUX,QAAQ,CAACY,UAAT,CAAoBD,IAApB,CAAtB,CAAD,IACA,CAACX,QAAQ,CAACY,UAAT,CAAoB,GAApB,CADD,IAEA,CAACC,cAAKC,YAAL,CAAkBJ,IAAlB,CAAwBC,IAAD,IAAUX,QAAQ,CAACY,UAAT,CAAqB,GAAED,IAAK,GAA5B,CAAjC,CAFD,IAGA,CAACE,cAAKC,YAAL,CAAkBC,QAAlB,CAA2Bf,QAA3B,CAHD,IAIA,CAACZ,mBAAmB,CAAC2B,QAApB,CAA6Bf,QAA7B,CALH,EAME;AACAZ,UAAAA,mBAAmB,CAAC4B,IAApB,CAAyBhB,QAAzB;AACAX,UAAAA,2BAA2B,CAAC2B,IAA5B,CAAiCxB,YAAjC;AACD;AACF,OAvBa;;AAwBdyB,MAAAA,cAAc,CAAClB,SAAD,EAAY;AACxB,YAAIA,SAAS,CAACE,IAAV,CAAeiB,MAAf,CAAsBV,IAAtB,KAA+B,SAAnC,EAA8C;AAC5C;AACD;;AACD,YAAIR,QAAQ,GAAGD,SAAS,CAACE,IAAV,CAAekB,SAAf,CAAyB,CAAzB,EAA4BhB,KAA3C;AACA,cAAMC,QAAQ,GAAGJ,QAAQ,CAACK,KAAT,CAAeC,cAAKC,GAApB,CAAjB;AACA,cAAMC,IAAI,GAAGJ,QAAQ,CAAC,CAAD,CAArB;;AAEA,YAAII,IAAI,CAAC,CAAD,CAAJ,KAAY,GAAhB,EAAqB;AACnB,gBAAMC,UAAU,GAAGL,QAAQ,CAAC,CAAD,CAA3B;AACAJ,UAAAA,QAAQ,GAAI,GAAEQ,IAAK,IAAGC,UAAW,EAAjC;AACD,SAHD,MAGO;AACLT,UAAAA,QAAQ,GAAGQ,IAAX;AACD;;AAED,YACE,CAAC/B,MAAM,CAACiC,IAAP,CAAaC,IAAD,IAAUX,QAAQ,CAACY,UAAT,CAAoBD,IAApB,CAAtB,CAAD,IACA,CAACX,QAAQ,CAACY,UAAT,CAAoB,GAApB,CADD,IAEA,CAACC,cAAKC,YAAL,CAAkBJ,IAAlB,CAAwBC,IAAD,IAAUX,QAAQ,CAACY,UAAT,CAAqB,GAAED,IAAK,GAA5B,CAAjC,CAFD,IAGA,CAACE,cAAKC,YAAL,CAAkBC,QAAlB,CAA2Bf,QAA3B,CAHD,IAIA,CAACZ,mBAAmB,CAAC2B,QAApB,CAA6Bf,QAA7B,CALH,EAME;AACAZ,UAAAA,mBAAmB,CAAC4B,IAApB,CAAyBhB,QAAzB;AACAX,UAAAA,2BAA2B,CAAC2B,IAA5B,CAAiCxB,YAAjC;AACD;AACF;;AAjDa,KAAhB;AAmDA,2BAAcE,GAAd,EAAmBG,OAAnB;AACD,GA3DK,CAAN;AA6DA,QAAMuB,gBAAgB,GAAG,EAAzB;AACA,QAAMC,gBAAgB,GAAG,EAAzB;AACA,QAAM/B,kBAASC,GAAT,CAAaH,mBAAb,EAAkC,OAAOY,QAAP,EAAiBsB,KAAjB,KAA2B;AACjE,UAAM9B,YAAY,GAAGH,2BAA2B,CAACiC,KAAD,CAAhD;AACA,UAAMC,qBAAqB,GAAG7C,WAAW,CAACQ,YAAZ,CAAyBc,QAAzB,CAA9B;AACA,UAAMwB,wBAAwB,GAAG9C,WAAW,CAACS,eAAZ,CAA4Ba,QAA5B,CAAjC;AACA,UAAMyB,kBAAkB,GAAGF,qBAAqB,IAAIC,wBAApD;;AACA,UAAME,OAAO,GAAG,2BAAclC,YAAd,CAAhB;;AACA,QAAImC,eAAJ;;AACA,QAAI;AACFA,MAAAA,eAAe,GAAGC,UAAU,CAACF,OAAO,CAACG,OAAR,CAAgB7B,QAAhB,CAAD,CAA5B;AACD,KAFD,CAEE,OAAO8B,KAAP,EAAc;AACd,YAAMC,YAAY,GAAGD,KAAK,CAACE,OAAN,CAAcC,KAAd,CAAoB,yBAApB,CAArB;;AACA,UAAIF,YAAJ,EAAkB;AAChB,cAAMG,UAAU,GAAG,CACjBJ,KAAK,CAACE,OAAN,CAAcG,KAAd,CAAoB,CAApB,EAAuBJ,YAAY,CAAC,CAAD,CAAZ,CAAgBK,MAAvC,CADiB,EAEhB,iCAAgCL,YAAY,CAAC,CAAD,CAAI,qBAFhC,EAGjBD,KAAK,CAACE,OAAN,CAAcG,KAAd,CAAoBJ,YAAY,CAAC,CAAD,CAAZ,CAAgBK,MAApC,CAHiB,EAIjBC,IAJiB,CAIZ,EAJY,CAAnB;AAKAP,QAAAA,KAAK,CAACE,OAAN,GAAgBE,UAAhB;AACD;;AACD,YAAMJ,KAAN;AACD;;AACD,UAAMQ,WAAW,GAAG,MAAMvD,kBAAGC,QAAH,CAAa,GAAE2C,eAAgB,eAA/B,EAA+C;AACvE1C,MAAAA,QAAQ,EAAE;AAD6D,KAA/C,CAA1B;AAGA,UAAMsD,kBAAkB,GAAG1D,IAAI,CAACC,KAAL,CAAWwD,WAAX,EAAwBE,OAAnD;AACApB,IAAAA,gBAAgB,CAACpB,QAAD,CAAhB,GAA6ByB,kBAAkB,IAAI,SAAnD;AACAJ,IAAAA,gBAAgB,CAACrB,QAAD,CAAhB,GAA6BuC,kBAAkB,IAAI,SAAnD;AACD,GA3BK,CAAN;AA6BA,QAAME,sBAAsB,GAAGC,MAAM,CAACC,IAAP,CAAYvB,gBAAZ,EAC5BwB,IAD4B,GAE5BC,MAF4B,CAErB,CAACC,GAAD,EAAMC,GAAN,KAAc;AACpBD,IAAAA,GAAG,CAACC,GAAD,CAAH,GAAW3B,gBAAgB,CAAC2B,GAAD,CAA3B;AACA,WAAOD,GAAP;AACD,GAL4B,EAK1B,EAL0B,CAA/B;AAOA,QAAME,sBAAsB,GAAGN,MAAM,CAACC,IAAP,CAAYtB,gBAAZ,EAC5BuB,IAD4B,GAE5BC,MAF4B,CAErB,CAACC,GAAD,EAAMC,GAAN,KAAc;AACpBD,IAAAA,GAAG,CAACC,GAAD,CAAH,GAAW1B,gBAAgB,CAAC0B,GAAD,CAA3B;AACA,WAAOD,GAAP;AACD,GAL4B,EAK1B,EAL0B,CAA/B;AAOA,QAAM5D,YAAY,GAAGwD,MAAM,CAACC,IAAP,CAAYF,sBAAZ,EAAoCI,MAApC,CAA2C,CAACC,GAAD,EAAMC,GAAN,KAAc;AAC5ED,IAAAA,GAAG,CAACC,GAAD,CAAH,GACEN,sBAAsB,CAACM,GAAD,CAAtB,KAAgC,SAAhC,GACIC,sBAAsB,CAACD,GAAD,CAD1B,GAEIN,sBAAsB,CAACM,GAAD,CAH5B;AAIA,WAAOD,GAAP;AACD,GANoB,EAMlB,EANkB,CAArB;AAQA,SAAO5D,YAAP;AACD;;AAED,SAAS0C,UAAT,CAAoBqB,UAApB,EAAgC;AAC9B,QAAM7C,QAAQ,GAAG6C,UAAU,CAAC5C,KAAX,CAAiB,GAAjB,CAAjB;AACA,QAAMiB,KAAK,GAAGlB,QAAQ,CAAC8C,WAAT,CAAqB,cAArB,CAAd;;AAEA,MAAI5B,KAAK,GAAG,CAAC,CAAb,EAAgB;AACd,UAAMd,IAAI,GAAGJ,QAAQ,CAACkB,KAAK,GAAG,CAAT,CAArB;;AAEA,QAAId,IAAI,CAAC,CAAD,CAAJ,KAAY,GAAhB,EAAqB;AACnB,aAAOJ,QAAQ,CAAC+B,KAAT,CAAe,CAAf,EAAkBb,KAAK,GAAG,CAA1B,EAA6Be,IAA7B,CAAkC,GAAlC,CAAP;AACD,KAFD,MAEO;AACL,aAAOjC,QAAQ,CAAC+B,KAAT,CAAe,CAAf,EAAkBb,KAAK,GAAG,CAA1B,EAA6Be,IAA7B,CAAkC,GAAlC,CAAP;AACD;AACF,GARD,MAQO;AACL,UAAM,IAAIc,SAAJ,CAAc,uBAAd,CAAN;AACD;AACF","sourcesContent":["import path from 'path';\nimport fs from 'fs/promises';\nimport repl from 'repl';\nimport { createRequire } from 'module';\nimport Bluebird from 'bluebird';\nimport _ from 'lodash';\nimport { parse as babelParse } from '@babel/parser';\nimport babelTraverse from '@babel/traverse';\n\nexport default async function generateDeps(filePathList, hostpkgJsonPath, { ignore = [] } = {}) {\n  const hostPkgJson = _.defaults(\n    JSON.parse(await fs.readFile(hostpkgJsonPath, { encoding: 'utf8' })),\n    {\n      dependencies: {},\n      devDependencies: {},\n    }\n  );\n\n  const dependenciesRawList = [];\n  const dependenciesRawListFilePath = [];\n\n  await Bluebird.map(filePathList, async (filePathItem) => {\n    const inputCode = await fs.readFile(filePathItem, { encoding: 'utf8' });\n    const ast = babelParse(inputCode, {\n      sourceType: 'module',\n      plugins: ['jsx', 'typescript'],\n    });\n\n    const visitor = {\n      ImportDeclaration(babelPath) {\n        let moduleId = babelPath.node.source.value;\n        const segments = moduleId.split(path.sep);\n        const name = segments[0];\n\n        if (name[0] === '@') {\n          const scopedName = segments[1];\n          moduleId = `${name}/${scopedName}`;\n        } else {\n          moduleId = name;\n        }\n\n        if (\n          !ignore.some((item) => moduleId.startsWith(item)) &&\n          !moduleId.startsWith('.') &&\n          !repl._builtinLibs.some((item) => moduleId.startsWith(`${item}/`)) &&\n          !repl._builtinLibs.includes(moduleId) &&\n          !dependenciesRawList.includes(moduleId)\n        ) {\n          dependenciesRawList.push(moduleId);\n          dependenciesRawListFilePath.push(filePathItem);\n        }\n      },\n      CallExpression(babelPath) {\n        if (babelPath.node.callee.name !== 'require') {\n          return;\n        }\n        let moduleId = babelPath.node.arguments[0].value;\n        const segments = moduleId.split(path.sep);\n        const name = segments[0];\n\n        if (name[0] === '@') {\n          const scopedName = segments[1];\n          moduleId = `${name}/${scopedName}`;\n        } else {\n          moduleId = name;\n        }\n\n        if (\n          !ignore.some((item) => moduleId.startsWith(item)) &&\n          !moduleId.startsWith('.') &&\n          !repl._builtinLibs.some((item) => moduleId.startsWith(`${item}/`)) &&\n          !repl._builtinLibs.includes(moduleId) &&\n          !dependenciesRawList.includes(moduleId)\n        ) {\n          dependenciesRawList.push(moduleId);\n          dependenciesRawListFilePath.push(filePathItem);\n        }\n      },\n    };\n    babelTraverse(ast, visitor);\n  });\n\n  const hostDependencies = {};\n  const realdependencies = {};\n  await Bluebird.map(dependenciesRawList, async (moduleId, index) => {\n    const filePathItem = dependenciesRawListFilePath[index];\n    const hostPkgJsonDepVersion = hostPkgJson.dependencies[moduleId];\n    const hostPkgJsonDevDepVersion = hostPkgJson.devDependencies[moduleId];\n    const hostPkgJsonVersion = hostPkgJsonDepVersion || hostPkgJsonDevDepVersion;\n    const require = createRequire(filePathItem);\n    let realPkgJsonPath;\n    try {\n      realPkgJsonPath = resolvePkg(require.resolve(moduleId));\n    } catch (error) {\n      const messageMatch = error.message.match(/Cannot find module (.*)/);\n      if (messageMatch) {\n        const newMessage = [\n          error.message.slice(0, messageMatch[0].length),\n          `, install it or use \"--ignore ${messageMatch[1]}\" to fix this issue`,\n          error.message.slice(messageMatch[0].length),\n        ].join('');\n        error.message = newMessage;\n      }\n      throw error;\n    }\n    const realPkgJson = await fs.readFile(`${realPkgJsonPath}/package.json`, {\n      encoding: 'utf8',\n    });\n    const realPkgJsonVersion = JSON.parse(realPkgJson).version;\n    hostDependencies[moduleId] = hostPkgJsonVersion || 'missing';\n    realdependencies[moduleId] = realPkgJsonVersion || 'missing';\n  });\n\n  const hostDependenciesSorted = Object.keys(hostDependencies)\n    .sort()\n    .reduce((acc, key) => {\n      acc[key] = hostDependencies[key];\n      return acc;\n    }, {});\n\n  const realDependenciesSorted = Object.keys(realdependencies)\n    .sort()\n    .reduce((acc, key) => {\n      acc[key] = realdependencies[key];\n      return acc;\n    }, {});\n\n  const dependencies = Object.keys(hostDependenciesSorted).reduce((acc, key) => {\n    acc[key] =\n      hostDependenciesSorted[key] === 'missing'\n        ? realDependenciesSorted[key]\n        : hostDependenciesSorted[key];\n    return acc;\n  }, {});\n\n  return dependencies;\n}\n\nfunction resolvePkg(modulePath) {\n  const segments = modulePath.split('/');\n  const index = segments.lastIndexOf('node_modules');\n\n  if (index > -1) {\n    const name = segments[index + 1];\n\n    if (name[0] === '@') {\n      return segments.slice(0, index + 3).join('/');\n    } else {\n      return segments.slice(0, index + 2).join('/');\n    }\n  } else {\n    throw new TypeError(\"Couldn't find package\");\n  }\n}\n"],"file":"generate-deps.js"}